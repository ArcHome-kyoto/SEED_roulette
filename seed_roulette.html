<script>
// -----------------------------
//  ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
// -----------------------------
function createConfetti() {
    const confettiContainer = document.createElement('div');
    confettiContainer.style.position = "fixed";
    confettiContainer.style.top = "0";
    confettiContainer.style.left = "0";
    confettiContainer.style.width = "100%";
    confettiContainer.style.height = "100%";
    confettiContainer.style.pointerEvents = "none";
    confettiContainer.style.overflow = "hidden";
    document.body.appendChild(confettiContainer);

    for (let i = 0; i < 100; i++) {
        const confetti = document.createElement("div");
        confetti.style.position = "absolute";
        confetti.style.width = "8px";
        confetti.style.height = "8px";
        confetti.style.backgroundColor = randomColor();
        confetti.style.top = "-10px";
        confetti.style.left = Math.random() * 100 + "%";
        confetti.style.opacity = Math.random() + "";
        confetti.style.transform = "rotate(" + Math.random() * 360 + "deg)";
        confettiContainer.appendChild(confetti);

        const fallDuration = 2000 + Math.random() * 3000;
        const horizontalMove = (Math.random() - 0.5) * 200;

        confetti.animate([
            { transform: "translate(0, 0) rotate(0deg)" },
            { transform: `translate(${horizontalMove}px, 100vh) rotate(720deg)` }
        ], {
            duration: fallDuration,
            easing: "ease-out",
            iterations: 1
        });
    }

    setTimeout(() => confettiContainer.remove(), 5000);
}

function randomColor() {
    const colors = ["#FF5733", "#FFC300", "#DAF7A6", "#33FFBD", "#3380FF", "#BD33FF"];
    return colors[Math.floor(Math.random() * colors.length)];
}

// -----------------------------
//  BGM
// -----------------------------
let bgmStart = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-game-level-start-2050.mp3");
let bgmWin   = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3");

// -----------------------------
//  ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå›è»¢
// -----------------------------
let currentIndex = 0;
let rouletteTimer = null;

function startRoulette() {
    if (members.length === 0) return;

    if (!rouletteTimer) {
        rouletteTimer = setInterval(() => {
            currentIndex = (currentIndex + 1) % members.length;
            drawRoulette();
        }, 80);
    }
}

function stopRoulette() {
    clearInterval(rouletteTimer);
    rouletteTimer = null;
}

// -----------------------------
//  ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹ãƒœã‚¿ãƒ³
// -----------------------------
let targetWinnersCount = 1;
let finishedWinners = 0;
let drawing = false;

document.getElementById("start").onclick = () => {
    if (drawing) return; // å¤šé‡å®Ÿè¡Œé˜²æ­¢
    targetWinnersCount = parseInt(document.getElementById("winnersCount").value);

    if (targetWinnersCount <= 0) {
        alert("å½“é¸äººæ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }

    finishedWinners = 0;
    winners = [];
    drawWinnersList();
    runNextDraw();
};

// -----------------------------
//  è‡ªå‹•ã§æ¬¡ã‚’å®Ÿè¡Œï¼ˆæ–¹å¼ï¼šâ‘¡Aï¼‰
// -----------------------------
function runNextDraw() {
    if (members.length === 0) {
        alert("ãƒ¡ãƒ³ãƒãƒ¼ãŒå…¨å“¡å½“é¸ã—ã¾ã—ãŸï¼");
        drawing = false;
        return;
    }

    if (finishedWinners >= targetWinnersCount) {
        drawing = false;
        return;
    }

    drawing = true;
    bgmStart.play();
    startRoulette();

    // ãƒ©ãƒ³ãƒ€ãƒ ãªæ™‚é–“ã§å¾ã€…ã«åœæ­¢
    const spinTime = 1500 + Math.random() * 2000;
    setTimeout(() => {
        stopRoulette();

        // å½“é¸è€…ã‚’æ±ºå®šï¼ˆãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä½ç½®ã«ã„ã‚‹äººï¼‰
        const winner = members[currentIndex];
        winners.push(winner);
        finishedWinners++;

        showWinnerPopup(winner);

        // ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚‰é™¤å¤–ï¼ˆé‡è¤‡ãªã—ï¼‰
        members.splice(currentIndex, 1);

        drawMembersList();
        drawRoulette();
        drawWinnersList();

        bgmWin.play();
        createConfetti();

        // 1ç§’å¾Œã«æ¬¡ã®æŠ½é¸ã¸ï¼ˆâ‘¡Aï¼‰
        setTimeout(() => {
            runNextDraw();
        }, 1000);

    }, spinTime);
}

// -----------------------------
//  å½“é¸è€…ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆâ‘ Bï¼‰
// -----------------------------
function showWinnerPopup(name) {
    const popup = document.getElementById("winnerPopup");
    popup.innerText = `ğŸ‰ ${name} ã•ã‚“ å½“é¸ï¼ ğŸ‰`;
    popup.style.opacity = 1;

    setTimeout(() => {
        popup.style.opacity = 0;
    }, 1500);
}

// -----------------------------
//  æç”»ç³»
// -----------------------------
function drawRoulette() {
    const cvs = document.getElementById("roulette");
    const ctx = cvs.getContext("2d");
    ctx.clearRect(0, 0, cvs.width, cvs.height);

    if (members.length === 0) return;

    ctx.fillStyle = "#333";
    ctx.beginPath();
    ctx.arc(200, 200, 180, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = "white";
    ctx.font = "24px Arial";
    ctx.textAlign = "center";
    ctx.fillText(members[currentIndex].split(':')[0], 200, 210);
}

function drawMembersList() {
    const list = document.getElementById("memberList");
    list.innerHTML = "";
    members.forEach((m, i) => {
        const name = m.split(':')[0];
        list.innerHTML += `<li>${name}</li>`;
    });
}

function drawWinnersList() {
    const list = document.getElementById("winnersList");
    list.innerHTML = "";
    winners.forEach((m, i) => {
        const name = m.split(':')[0];
        list.innerHTML += `<li>${i + 1}. ${name}</li>`;
    });
}

// åˆæœŸè¡¨ç¤º
drawRoulette();
</script>
</body>
</html>
