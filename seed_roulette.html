function renderPrizeList(){
  prizeListEl.innerHTML = "";

  prizes.forEach((p, idx) => {
    const row = document.createElement("div");
    row.className = "prize-row";

    // カード（ここをクリックしてCtrl+Vできるようにする）
    const card = document.createElement("div");
    card.className = "prize-card";
    card.tabIndex = 0; // focus可能にして貼り付けを受ける

    const img = document.createElement("img");
    img.className = "prize-img";
    img.alt = p.name || "prize";
    img.src = p.imgDataUrl || "";

    const info = document.createElement("div");
    info.style.flex = "1";

    const title = document.createElement("div");
    title.className = "prize-title";
    title.textContent = p.name || `景品${idx+1}`;

    const nameInput = document.createElement("input");
    nameInput.className = "prize-input";
    nameInput.type = "text";
    nameInput.value = p.name;
    nameInput.placeholder = "景品名（例：A賞：Amazonギフト）";

    // コントロール
    const controls = document.createElement("div");
    controls.className = "prize-controls";

    const fileInput = document.createElement("input");
    fileInput.className = "prize-file";
    fileInput.type = "file";
    fileInput.accept = "image/*";

    const clearImgBtn = document.createElement("button");
    clearImgBtn.className = "prize-clearimg";
    clearImgBtn.type = "button";
    clearImgBtn.textContent = "画像クリア";

    const removeBtn = document.createElement("button");
    removeBtn.className = "prize-remove";
    removeBtn.type = "button";
    removeBtn.textContent = "景品削除";

    // --- イベント ---
    nameInput.addEventListener("input", (e)=>{
      prizes[idx].name = e.target.value;
      title.textContent = e.target.value || `景品${idx+1}`;
    });

    // PCから画像選択 → DataURL化して保存＆表示
    fileInput.addEventListener("change", async (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith("image/")) return;

      const dataUrl = await fileToDataUrl(file);
      prizes[idx].imgDataUrl = dataUrl;
      img.src = dataUrl;

      // 同じファイルを再度選べるようにリセット
      fileInput.value = "";
    });

    // 画像クリア
    clearImgBtn.addEventListener("click", ()=>{
      prizes[idx].imgDataUrl = "";
      img.src = "";
    });

    // 景品削除
    removeBtn.addEventListener("click", ()=>{
      prizes.splice(idx, 1);
      renderPrizeList();
    });

    // Ctrl+V / ⌘+V で画像貼り付け（カードがフォーカスされている時）
    card.addEventListener("paste", async (e)=>{
      const items = e.clipboardData && e.clipboardData.items;
      if (!items) return;

      for (const it of items) {
        if (it.type && it.type.startsWith("image/")) {
          const file = it.getAsFile();
          if (!file) continue;
          const dataUrl = await fileToDataUrl(file);
          prizes[idx].imgDataUrl = dataUrl;
          img.src = dataUrl;
          e.preventDefault();
          break;
        }
      }
    });

    info.appendChild(title);
    info.appendChild(nameInput);

    controls.appendChild(fileInput);
    controls.appendChild(clearImgBtn);
    controls.appendChild(removeBtn);

    card.appendChild(img);
    card.appendChild(info);
    card.appendChild(controls);

    row.appendChild(card);
    prizeListEl.appendChild(row);
  });
}

function addPrize(){
  prizes.push({ name: `新景品${prizes.length + 1}`, imgDataUrl: "" });
  renderPrizeList();
}

function fileToDataUrl(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = ()=> resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

addPrizeBtn.addEventListener("click", addPrize);
renderPrizeList();
